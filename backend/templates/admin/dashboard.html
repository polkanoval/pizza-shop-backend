{% extends "admin/index.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/dashboard.css' %}">
<style>
    /* Вставляем твой CSS */
    .dashboard td, .dashboard th { word-break: break-word; }
    .dashboard .module table th { width: 100%; }
    .dashboard .module table td { white-space: nowrap; }
    .dashboard .module table td a { display: block; padding-right: .6em; }

    .module ul.actionlist { margin-left: 0; }
    ul.actionlist li { list-style-type: none; overflow: hidden; text-overflow: ellipsis; }

    /* Стили для карточек (если не подгрузились из внешнего CSS) */
    .small-box { border-radius: 0.25rem; position: relative; display: block; margin-bottom: 20px; color: #fff; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    .small-box .inner h3 { font-size: 2.2rem; font-weight: bold; margin: 0 0 10px 0; white-space: nowrap; padding: 0; }
    .small-box .icon { position: absolute; top: 15px; right: 15px; z-index: 0; font-size: 50px; color: rgba(0,0,0,0.15); }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-success { background-color: #28a745 !important; }
    .bg-warning { background-color: #ffc107 !important; color: #1f2d3d !important; }
    .bg-danger { background-color: #dc3545 !important; }
    .bg-primary { background-color: #007bff !important; }

    /* Адаптивность */
    @media (max-width: 768px) {
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .dashboard .module table td { white-space: normal !important; min-width: 120px; }
        .small-box h3 { font-size: 1.6rem !important; }
        .card-body.p-0 { padding: 10px !important; }
        .small-box .icon { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main" style="width: 100%;">
    <!-- Блок статистики (Верхний ряд) -->
    <div class="row" style="display: flex; flex-wrap: wrap; margin-bottom: 20px;">
        <div class="col-lg-6" style="flex: 0 0 50%; padding: 10px;">
            <div class="small-box bg-info">
                <div class="inner"><h3>{{ orders_count }}</h3><p>Заказов сегодня</p></div>
                <div class="icon"><i class="fas fa-shopping-cart"></i></div>
            </div>
        </div>
        <div class="col-lg-6" style="flex: 0 0 50%; padding: 10px;">
            <div class="small-box bg-success">
                <div class="inner"><h3>{{ total_revenue }} ₽</h3><p>Выручки сегодня</p></div>
                <div class="icon"><i class="fas fa-ruble-sign"></i></div>
            </div>
        </div>
    </div>

    <!-- Блок статистики (Средний ряд) -->
    <div class="row" style="display: flex; flex-wrap: wrap; margin-bottom: 20px;">
        <div class="col-lg-4" style="flex: 1; padding: 10px;">
            <div class="small-box bg-warning">
                <div class="inner"><h3>{{ orders_week_count }}</h3><p>Заказов за неделю</p></div>
                <div class="icon"><i class="fas fa-clock"></i></div>
            </div>
        </div>
        <div class="col-lg-4" style="flex: 1; padding: 10px;">
            <div class="small-box bg-danger">
                <div class="inner"><h3>{{ orders_month_count }}</h3><p>Заказов за месяц</p></div>
                <div class="icon"><i class="fas fa-calendar-alt"></i></div>
            </div>
        </div>
        <div class="col-lg-4" style="flex: 1; padding: 10px;">
            <div class="small-box bg-primary">
                <div class="inner"><h3>{{ revenue_month }} ₽</h3><p>Выручки за месяц</p></div>
                <div class="icon"><i class="fas fa-ruble-sign"></i></div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row" style="display: flex; flex-wrap: wrap; margin-bottom: 30px;">
        <div class="col-md-6" style="flex: 0 0 50%; padding: 10px;">
            <div class="card" style="background: #fff; border: 1px solid #ddd; padding: 15px;">
                <div class="card-header"><strong>Выручка за неделю</strong></div>
                <div class="card-body"><canvas id="revChart" height="150"></canvas></div>
            </div>
        </div>
        <div class="col-md-6" style="flex: 0 0 50%; padding: 10px;">
            <div class="card" style="background: #fff; border: 1px solid #ddd; padding: 15px;">
                <div class="card-header"><strong>Топ пицц</strong></div>
                <div class="card-body"><canvas id="pizzaChart" height="150"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Таблица последних заказов -->
    <div class="row" style="padding: 10px;">
        <div class="card" style="background: #fff; border: 1px solid #ddd; width: 100%;">
            <div class="card-header" style="padding: 15px; border-bottom: 1px solid #eee;">
                <h3 class="card-title" style="display: inline-block;">Последние заказы</h3>
                <a href="{% url 'admin:order_order_changelist' %}" style="float: right; background: #79aec8; color: #fff; padding: 5px 10px; text-decoration: none; border-radius: 4px;">Посмотреть все</a>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f8f8; text-align: left; border-bottom: 2px solid #eee;">
                            <th style="padding: 12px;">ID</th>
                            <th style="padding: 12px;">Клиент</th>
                            <th style="padding: 12px;">Продукты</th>
                            <th style="padding: 12px;">Сумма</th>
                            <th style="padding: 12px;">Статус</th>
                            <th style="padding: 12px;">Время</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;"><a href="{% url 'admin:order_order_change' order.id %}">#{{ order.order_number }}</a></td>
                            <td style="padding: 12px;">{{ order.customer_name }}</td>
                            <td style="padding: 12px;">
                                {% for item in order.items.all %}
                                    {{ item.pizza.name }} ({{ item.quantity }} шт.){% if not forloop.last %}, {% endif %}
                                {% empty %} Нет товаров {% endfor %}
                            </td>
                            <td style="padding: 12px;">{{ order.final_price }} ₽</td>
                            <td style="padding: 12px;"><span style="padding: 4px 8px; border-radius: 4px;" class="badge bg-{{ order.status|lower|yesno:'success,warning,info' }}">{{ order.get_status_display }}</span></td>
                            <td style="padding: 12px;">{{ order.created_at|timesince }} назад</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" style="padding: 20px; text-align: center;">Заказов пока нет.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ labels_revenue|json_script:"labels-revenue" }}
{{ data_revenue|json_script:"data-revenue" }}
{{ labels_pizza|json_script:"labels-pizza" }}
{{ data_pizza|json_script:"data-pizza" }}

<script>
    (function() {
        const labelsRevenue = JSON.parse(document.getElementById('labels-revenue').textContent);
        const dataRevenue = JSON.parse(document.getElementById('data-revenue').textContent).map(Number);
        const labelsPizza = JSON.parse(document.getElementById('labels-pizza').textContent);
        const dataPizza = JSON.parse(document.getElementById('data-pizza').textContent).map(Number);

        new Chart(document.getElementById('revChart'), {
            type: 'line',
            data: {
                labels: labelsRevenue,
                datasets: [{
                    label: 'Выручка',
                    data: dataRevenue,
                    borderColor: '#4bc0c0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                }]
            }
        });

        new Chart(document.getElementById('pizzaChart'), {
            type: 'pie',
            data: {
                labels: labelsPizza,
                datasets: [{
                    data: dataPizza,
                    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40']
                }]
            }
        });
    })();
</script>
{% endblock %}